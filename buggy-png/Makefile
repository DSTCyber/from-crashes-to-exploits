CC = gcc
TARGET = buggy-png
SRC = src/main.c src/png.c
HEADERS = src/png.h
LIBS = -lz

CFLAGS = -m32               \
         -O0                \
         -g                 \
         -Wall              \
         -Wl,-z,norelro     \
         -z execstack       \
         -fno-pie           \
         -fno-stack-protector

AFL_CC ?= afl-gcc
AFL_TARGET = $(TARGET).afl

.PHONY: default clean

default: all

all: $(TARGET) $(AFL_TARGET)

$(TARGET): $(SRC) $(HEADERS)
	$(info Compiling buggy target...)
	$(CC) $(CFLAGS) -o $@ $(SRC) $(LIBS)

$(AFL_TARGET): $(SRC) $(HEADERS)
	$(info Compiling instrumented version for AFL...)
	AFL_DONT_OPTIMIZE=1 $(AFL_CC) $(CFLAGS) -o $@ $(SRC) $(LIBS)

clean:
	rm -f $(TARGET) $(TARGET).afl
